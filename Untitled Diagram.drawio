<mxfile host="app.diagrams.net" modified="2021-12-20T09:13:00.835Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36 Edg/96.0.1054.57" etag="ltuc6FPdHWyO0X4yipxQ" version="16.0.0" type="github">
  <diagram id="2zftxFfZJoa_WkWcQfK9" name="Page-1">
    <mxGraphModel dx="3850" dy="3102" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-65" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-1" target="9TWHAg7jtCrfxQBwRMBd-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-1" value="main" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-160" y="410" width="190" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-4" target="9TWHAg7jtCrfxQBwRMBd-6" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="310" y="430" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-4" value="initServer&lt;br&gt;初始化server" style="rounded=0;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);fillColor=rgb(255, 255, 255);" parent="1" vertex="1">
          <mxGeometry x="80" y="410" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-6" target="9TWHAg7jtCrfxQBwRMBd-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-6" value="&lt;pre style=&quot;background-color: #2b2b2b ; color: #a9b7c6 ; font-family: &amp;#34;jetbrains mono&amp;#34; , monospace ; font-size: 9.8pt&quot;&gt;&lt;/pre&gt;listenToPort&lt;br&gt;监听端口" style="rounded=0;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);fillColor=rgb(255, 255, 255);" parent="1" vertex="1">
          <mxGeometry x="240" y="410" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-7" target="9TWHAg7jtCrfxQBwRMBd-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-7" value="aeCreateTimeEvent&lt;br&gt;创建时间使事件" style="rounded=0;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);fillColor=rgb(255, 255, 255);" parent="1" vertex="1">
          <mxGeometry x="260" y="490" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-9" target="9TWHAg7jtCrfxQBwRMBd-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-9" value="createSocketAcceptHandler&lt;br&gt;创建socket处理事件" style="rounded=0;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);fillColor=rgb(255, 255, 255);" parent="1" vertex="1">
          <mxGeometry x="240" y="584.5" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-11" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="740" y="615" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-11" target="9TWHAg7jtCrfxQBwRMBd-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-11" value="aeCreateFileEvent&lt;br&gt;创建IO事件" style="whiteSpace=wrap;html=1;fillColor=rgb(255, 255, 255);strokeColor=rgb(0, 0, 0);fontColor=rgb(0, 0, 0);rounded=0;" parent="1" vertex="1">
          <mxGeometry x="430" y="587" width="260" height="55" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-43" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="9TWHAg7jtCrfxQBwRMBd-15" target="9TWHAg7jtCrfxQBwRMBd-46" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="650" y="120" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-44" value="加入在socket的fd位置下设置accpetTcpHandler" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;fontFamily=Helvetica;fontColor=rgb(0, 0, 0);" parent="9TWHAg7jtCrfxQBwRMBd-43" vertex="1" connectable="0">
          <mxGeometry x="-0.2788" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-15" value="&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;// 根据acCreateFileEvent传递的fd来获取events数组中指定为位制地址&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;aeFileEvent *fe = &amp;amp;eventLoop-&amp;gt;events[fd];&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;// 给事件设置处理函数这里传入的是&lt;/span&gt;&lt;span&gt;acceptTcpHandler&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;span&gt;&lt;div&gt;if (mask &amp;amp; AE_READABLE) fe-&amp;gt;rfileProc = proc;&lt;/div&gt;&lt;div&gt;if (mask &amp;amp; AE_WRITABLE) fe-&amp;gt;wfileProc = proc;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=0;fontFamily=Helvetica;fontSize=12;strokeColor=#d6b656;fillColor=#fff2cc;" parent="1" vertex="1">
          <mxGeometry x="740" y="490" width="390" height="200" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-45" value="EVENTS" style="shape=table;startSize=40;container=1;collapsible=0;childLayout=tableLayout;fontStyle=1;align=center;pointerEvents=1;rounded=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);fillColor=rgb(255, 255, 255);html=1;" parent="1" vertex="1">
          <mxGeometry x="680" y="-20" width="120" height="158" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-46" value="" style="shape=partialRectangle;html=1;whiteSpace=wrap;collapsible=0;dropTarget=0;pointerEvents=0;fillColor=none;top=0;left=0;bottom=0;right=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rounded=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);" parent="9TWHAg7jtCrfxQBwRMBd-45" vertex="1">
          <mxGeometry y="40" width="120" height="44" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-47" value="&lt;span style=&quot;color: rgb(0 , 0 , 0) ; font-family: &amp;#34;helvetica&amp;#34; ; font-size: 12px ; font-style: normal ; font-weight: 400 ; letter-spacing: normal ; text-indent: 0px ; text-transform: none ; word-spacing: 0px ; background-color: rgb(248 , 249 , 250) ; display: inline ; float: none&quot;&gt;acceptTcpHandler&lt;/span&gt;" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;fillColor=none;top=0;left=0;bottom=0;right=0;overflow=hidden;pointerEvents=1;rounded=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);align=center;verticalAlign=middle;" parent="9TWHAg7jtCrfxQBwRMBd-46" vertex="1">
          <mxGeometry width="120" height="44" as="geometry">
            <mxRectangle width="120" height="44" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-50" value="" style="shape=partialRectangle;html=1;whiteSpace=wrap;collapsible=0;dropTarget=0;pointerEvents=0;fillColor=none;top=0;left=0;bottom=0;right=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rounded=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);" parent="9TWHAg7jtCrfxQBwRMBd-45" vertex="1">
          <mxGeometry y="84" width="120" height="37" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-51" value="readQueryFromClient" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;fillColor=none;top=0;left=0;bottom=0;right=0;overflow=hidden;pointerEvents=1;rounded=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);" parent="9TWHAg7jtCrfxQBwRMBd-50" vertex="1">
          <mxGeometry width="120" height="37" as="geometry">
            <mxRectangle width="120" height="37" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-54" value="" style="shape=partialRectangle;html=1;whiteSpace=wrap;collapsible=0;dropTarget=0;pointerEvents=0;fillColor=none;top=0;left=0;bottom=0;right=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rounded=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);" parent="9TWHAg7jtCrfxQBwRMBd-45" vertex="1">
          <mxGeometry y="121" width="120" height="37" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-55" value="" style="shape=partialRectangle;html=1;whiteSpace=wrap;connectable=0;fillColor=none;top=0;left=0;bottom=0;right=0;overflow=hidden;pointerEvents=1;rounded=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);strokeColor=rgb(0, 0, 0);" parent="9TWHAg7jtCrfxQBwRMBd-54" vertex="1">
          <mxGeometry width="120" height="37" as="geometry">
            <mxRectangle width="120" height="37" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-60" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="9TWHAg7jtCrfxQBwRMBd-46" target="9TWHAg7jtCrfxQBwRMBd-63" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="530" y="152" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-63" value="&lt;div&gt;// 活动client的文件描述符&lt;/div&gt;&lt;div&gt;&amp;nbsp;cfd = anetTcpAccept(server.neterr, fd, cip, sizeof(cip), &amp;amp;cport);&lt;/div&gt;&lt;div&gt;&amp;nbsp;&lt;span style=&quot;white-space: pre&quot;&gt;	&lt;/span&gt;if (cfd == ANET_ERR) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (errno != EWOULDBLOCK)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; serverLog(LL_WARNING,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;Accepting client connection: %s&quot;, server.neterr);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;anetCloexec(cfd);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;serverLog(LL_VERBOSE,&quot;Accepted %s:%d&quot;, cip, cport);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;// 生成client事件&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;acceptCommonHandler(connCreateAcceptedSocket(cfd),0,cip);&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;strokeColor=#d6b656;fillColor=#fff2cc;align=left;" parent="1" vertex="1">
          <mxGeometry x="-50" y="-930" width="400" height="325" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-75" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="9TWHAg7jtCrfxQBwRMBd-64" target="9TWHAg7jtCrfxQBwRMBd-76" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="590" y="-534" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-64" value="//构建通用处理模板的方法&lt;br&gt;connection *connCreateSocket() {&lt;br&gt;&amp;nbsp; &amp;nbsp; connection *conn = zcalloc(sizeof(connection));&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; // 大量的处理模板&lt;br&gt;&amp;nbsp; &amp;nbsp; conn-&amp;gt;type = &amp;amp;CT_Socket;&lt;br&gt;&amp;nbsp; &amp;nbsp; conn-&amp;gt;fd = -1;&lt;br&gt;&amp;nbsp; &amp;nbsp; return conn;&lt;br&gt;}&lt;br&gt;&lt;br&gt;// 返回一个connectSoket&lt;br&gt;connection *connCreateAcceptedSocket(int fd) {&lt;br&gt;&amp;nbsp; &amp;nbsp; connection *conn = connCreateSocket();&lt;br&gt;&amp;nbsp; &amp;nbsp; conn-&amp;gt;fd = fd;&lt;br&gt;&amp;nbsp; &amp;nbsp; conn-&amp;gt;state = CONN_STATE_ACCEPTING;&lt;br&gt;&amp;nbsp; &amp;nbsp; return conn;&lt;br&gt;}" style="rounded=1;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;strokeColor=#d6b656;fillColor=#fff2cc;align=left;" parent="1" vertex="1">
          <mxGeometry x="10" y="-680" width="390" height="292" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-74" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-67" target="9TWHAg7jtCrfxQBwRMBd-73" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-67" value="&lt;div&gt;static void acceptCommonHandler(connection *conn, int flags, char *ip) {&lt;/div&gt;&lt;div&gt;&amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; /* Create connection and client */&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if ((c = createClient(conn)) == NULL) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; serverLog(LL_WARNING,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;Error registering fd event for the new client: %s (conn: %s)&quot;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connGetLastError(conn),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connGetInfo(conn, conninfo, sizeof(conninfo)));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connClose(conn); /* May be already closed, just ignore errors */&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; /* Last chance to keep flags */&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; c-&amp;gt;flags |= flags;&lt;/div&gt;&lt;div&gt;&lt;span&gt;		&lt;/span&gt;if (connAccept(conn, clientAcceptHandler) == C_ERR) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; char conninfo[100];&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (connGetState(conn) == CONN_STATE_ERROR)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; serverLog(LL_WARNING,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;Error accepting a client connection: %s (conn: %s)&quot;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connGetLastError(conn), connGetInfo(conn, conninfo, sizeof(conninfo)));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; freeClient(connGetPrivateData(conn));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;strokeColor=#d6b656;fillColor=#fff2cc;align=left;" parent="1" vertex="1">
          <mxGeometry x="80" y="-430" width="390" height="380" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-71" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-69" target="9TWHAg7jtCrfxQBwRMBd-72" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="740" y="760" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-69" value="&lt;div&gt;&amp;nbsp; &amp;nbsp; aeSetBeforeSleepProc(server.el,beforeSleep);&lt;/div&gt;&lt;div&gt;aeSetAfterSleepProc(server.el,afterSleep);&lt;/div&gt;" style="whiteSpace=wrap;html=1;fillColor=rgb(255, 255, 255);strokeColor=rgb(0, 0, 0);fontColor=rgb(0, 0, 0);rounded=0;align=left;" parent="1" vertex="1">
          <mxGeometry x="430" y="730" width="260" height="60" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-72" value="" style="rounded=1;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;strokeColor=#d6b656;fillColor=#fff2cc;" parent="1" vertex="1">
          <mxGeometry x="750" y="730" width="380" height="230" as="geometry" />
        </mxCell>
        <mxCell id="qlo0mlUVnGcfUICEwcEb-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" edge="1" parent="1" source="9TWHAg7jtCrfxQBwRMBd-73" target="9TWHAg7jtCrfxQBwRMBd-78">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qlo0mlUVnGcfUICEwcEb-3" value="readQueryFromClient" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;fontFamily=Helvetica;fontColor=rgb(0, 0, 0);" vertex="1" connectable="0" parent="qlo0mlUVnGcfUICEwcEb-1">
          <mxGeometry x="-0.1021" y="-1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-73" value="&lt;div&gt;client *createClient(connection *conn) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; client *c = zmalloc(sizeof(client));&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (conn) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connNonBlock(conn);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connEnableTcpNoDelay(conn);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (server.tcpkeepalive)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connKeepAlive(conn,server.tcpkeepalive);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connSetReadHandler(conn, readQueryFromClient);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; connSetPrivateData(conn, c);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;strokeColor=#d6b656;fillColor=#fff2cc;align=left;" parent="1" vertex="1">
          <mxGeometry x="660" y="-329" width="320" height="178" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" parent="1" source="9TWHAg7jtCrfxQBwRMBd-76" target="9TWHAg7jtCrfxQBwRMBd-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-76" value="&lt;div&gt;ConnectionType CT_Socket = {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .ae_handler = connSocketEventHandler,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .close = connSocketClose,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .write = connSocketWrite,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .read = connSocketRead,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .accept = connSocketAccept,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .connect = connSocketConnect,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .set_write_handler = connSocketSetWriteHandler,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .set_read_handler = connSocketSetReadHandler,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .get_last_error = connSocketGetLastError,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .blocking_connect = connSocketBlockingConnect,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .sync_write = connSocketSyncWrite,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .sync_read = connSocketSyncRead,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .sync_readline = connSocketSyncReadLine,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .get_type = connSocketGetType&lt;/div&gt;&lt;div style=&quot;&quot;&gt;};&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontFamily=Helvetica;fontSize=12;strokeColor=#d6b656;fillColor=#fff2cc;align=left;" parent="1" vertex="1">
          <mxGeometry x="660" y="-682" width="320" height="296" as="geometry" />
        </mxCell>
        <mxCell id="qlo0mlUVnGcfUICEwcEb-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontFamily=Helvetica;fontSize=12;fontColor=rgb(0, 0, 0);" edge="1" parent="1" source="9TWHAg7jtCrfxQBwRMBd-78" target="9TWHAg7jtCrfxQBwRMBd-50">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="qlo0mlUVnGcfUICEwcEb-4" value="创建client相关FD的读取事件" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;fontFamily=Helvetica;fontColor=rgb(0, 0, 0);" vertex="1" connectable="0" parent="qlo0mlUVnGcfUICEwcEb-2">
          <mxGeometry x="-0.4634" y="-5" relative="1" as="geometry">
            <mxPoint y="1" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="9TWHAg7jtCrfxQBwRMBd-78" value="&lt;div&gt;static int connSocketSetReadHandler(connection *conn, ConnectionCallbackFunc func) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (func == conn-&amp;gt;read_handler) return C_OK;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; conn-&amp;gt;read_handler = func;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (!conn-&amp;gt;read_handler)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; aeDeleteFileEvent(server.el,conn-&amp;gt;fd,AE_READABLE);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; else&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (aeCreateFileEvent(server.el,conn-&amp;gt;fd,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; AE_READABLE,conn-&amp;gt;type-&amp;gt;ae_handler,conn) == AE_ERR) return C_ERR;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return C_OK;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;align=left;fillColor=#fff2cc;strokeColor=#d6b656;fontColor=rgb(0, 0, 0);rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1100" y="-679" width="350" height="290" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
